<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Vehículos GPS</title>
<style>
  table, th, td { border: 1px solid black; border-collapse: collapse; padding: 4px; }
  th { background-color: #eee; }
  button { padding: 4px 8px; }
</style>
</head>
<body>
<h2>Vehículos GPS</h2>
<table id="tablaVehiculos">
  <thead>
    <tr>
      <th>NoFabricacin</th>
      <th>Ver en Google Maps</th>
    </tr>
  </thead>
  <tbody>
    <!-- Filas generadas dinámicamente -->
  </tbody>
</table>

<script>
async function obtenerDatosGPS(id) {
  try {
    const urlWS = `https://gps14.geolocaliza.com/gps/ws.php?wsKeyGrupo=still&wsAcc=vl&id=${id}&format=json`;
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(urlWS)}`;
    
    const response = await fetch(proxyUrl);
    const dataWrapped = await response.json();
    const gpsData = JSON.parse(dataWrapped.contents);

    return gpsData; // Array con los datos
  } catch (error) {
    console.error('Error al obtener GPS:', error);
    return null;
  }
}

function abrirGoogleMaps(lat, lon) {
  const url = `https://www.google.com/maps?q=${lat},${lon}`;
  window.open(url, '_blank');
}

// Ejemplo de datos de vehículos obtenidos desde Power Automate o BC
const vehiculos = [
  { NoFabricacin: '2677-FRH', gpsId: '6170' },
  { NoFabricacin: '3662-DBR', gpsId: '6171' }
];

async function generarTabla() {
  const tbody = document.getElementById('tablaVehiculos').querySelector('tbody');
  tbody.innerHTML = '';

  for (const veh of vehiculos) {
    const tr = document.createElement('tr');
    const tdNo = document.createElement('td');
    tdNo.textContent = veh.NoFabricacin;

    const tdBoton = document.createElement('td');
    const btn = document.createElement('button');
    btn.textContent = 'Ver en Maps';
    btn.onclick = async () => {
      const gpsData = await obtenerDatosGPS(veh.gpsId);
      if (gpsData && gpsData.length > 0) {
        abrirGoogleMaps(gpsData[0].lat, gpsData[0].long); // Usamos gpsData.long
      } else {
        alert('No se encontró la posición GPS');
      }
    };
    tdBoton.appendChild(btn);

    tr.appendChild(tdNo);
    tr.appendChild(tdBoton);
    tbody.appendChild(tr);
  }
}

// Generamos la tabla al cargar
window.onload = generarTabla;
</script>
</body>
</html>

